# ═══════════════════════════════════════════════════════════
# 🔧 ANSIBLE PLAYBOOK: Deploy Daily Deen Website
# ═══════════════════════════════════════════════════════════

---
- name: Deploy Daily Deen Website
  hosts: all
  become: yes
  gather_facts: yes

  tasks:
    # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    # TASK 1: Install Docker
    # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    - name: 📦 Update system packages
      yum:
        name: "*"
        state: latest
        update_cache: yes

    - name: 🐳 Install Docker
      shell: |
        amazon-linux-extras install docker -y
      args:
        creates: /usr/bin/docker

    - name: 🚀 Start and enable Docker
      systemd:
        name: docker
        state: started
        enabled: yes

    - name: 👤 Add ec2-user to docker group
      user:
        name: ec2-user
        groups: docker
        append: yes

    # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    # TASK 2: Deploy Website
    # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    - name: 📂 Create website directory
      file:
        path: /home/ec2-user/website
        state: directory
        owner: ec2-user
        group: ec2-user

    - name: 📄 Copy index.html
      copy:
        src: ./index.html
        dest: /home/ec2-user/website/index.html
        owner: ec2-user
        group: ec2-user

    - name: 📄 Copy Dockerfile
      copy:
        src: ./dockerfile
        dest: /home/ec2-user/website/Dockerfile
        owner: ec2-user
        group: ec2-user

    # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    # TASK 3: Build and Run Container
    # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    - name: 🏗️ Build Docker image
      shell: |
        docker build -t daily-deen:latest .
      args:
        chdir: /home/ec2-user/website
      become_user: ec2-user

    - name: 🛑 Stop old container
      shell: docker stop daily-deen-web || true
      become_user: ec2-user
      ignore_errors: yes

    - name: 🗑️ Remove old container
      shell: docker rm daily-deen-web || true
      become_user: ec2-user
      ignore_errors: yes

    - name: 🚀 Run new container
      shell: |
        docker run -d \
          --name daily-deen-web \
          --restart always \
          -p 80:80 \
          daily-deen:latest
      become_user: ec2-user

    - name: ✅ Verify deployment
      wait_for:
        port: 80
        delay: 5
        timeout: 30

    - name: 🎉 Success!
      debug:
        msg: "Website is live at http://{{ ansible_default_ipv4.address }}"
