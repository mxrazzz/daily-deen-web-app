# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸ”§ ANSIBLE PLAYBOOK: Deploy Daily Deen Website
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

---
- name: Deploy Daily Deen Website
  hosts: all
  become: yes
  gather_facts: yes

  tasks:
    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    # TASK 1: Install Docker
    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    - name: ğŸ“¦ Update system packages
      dnf:
        name: "*"
        state: latest
        update_cache: yes

    - name: ğŸ³ Install Docker
      dnf:
        name: docker
        state: present

    - name: ğŸš€ Start and enable Docker
      systemd:
        name: docker
        state: started
        enabled: yes

    - name: ğŸ‘¤ Add ec2-user to docker group
      user:
        name: ec2-user
        groups: docker
        append: yes

    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    # TASK 2: Deploy Website
    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    - name: ğŸ“‚ Create website directory
      file:
        path: /home/ec2-user/website
        state: directory
        owner: ec2-user
        group: ec2-user

    - name: ğŸ“„ Copy index.html
      copy:
        src: ./index.html
        dest: /home/ec2-user/website/index.html
        owner: ec2-user
        group: ec2-user

    - name: ğŸ“„ Copy Dockerfile
      copy:
        src: ./dockerfile
        dest: /home/ec2-user/website/Dockerfile
        owner: ec2-user
        group: ec2-user

    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    # TASK 3: Build and Run Container
    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    - name: ğŸ—ï¸ Build Docker image
      shell: |
        sudo docker build -t daily-deen:latest .
      args:
        chdir: /home/ec2-user/website

    - name: ğŸ›‘ Stop old container
      shell: sudo docker stop daily-deen-web || true
      ignore_errors: yes

    - name: ğŸ—‘ï¸ Remove old container
      shell: sudo docker rm daily-deen-web || true
      ignore_errors: yes

    - name: ğŸš€ Run new container
      shell: |
        sudo docker run -d \
          --name daily-deen-web \
          --restart always \
          -p 80:80 \
          daily-deen:latest

    - name: âœ… Verify deployment
      wait_for:
        port: 80
        delay: 5
        timeout: 30

    - name: ğŸ‰ Success!
      debug:
        msg: "Website is live at http://{{ ansible_default_ipv4.address }}"
