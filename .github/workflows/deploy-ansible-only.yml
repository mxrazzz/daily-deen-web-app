# ═══════════════════════════════════════════════════════════
# 🚀 ANSIBLE-ONLY DEPLOYMENT
# ═══════════════════════════════════════════════════════════
# This workflow ONLY runs Ansible (skips Terraform)
# Use this when infrastructure already exists!

name: Deploy Ansible Only

on:
  workflow_dispatch: # Manual trigger only

permissions:
  contents: read

jobs:
  deploy-ansible:
    name: Deploy with Ansible
    runs-on: ubuntu-latest

    steps:
      - name: 📥 Checkout code
        uses: actions/checkout@v4

      - name: 🔐 Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: 🔧 Setup Ansible
        run: |
          sudo apt-get update
          sudo apt-get install -y ansible

      - name: 🔑 Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/daily-deen-key
          chmod 600 ~/.ssh/daily-deen-key

          cat >> ~/.ssh/config <<EOF
          Host *
            StrictHostKeyChecking no
            UserKnownHostsFile=/dev/null
          EOF

      - name: 🔍 Get EC2 Public DNS
        id: get-dns
        run: |
          # Find the EC2 instance by tag
          DNS=$(aws ec2 describe-instances \
            --filters "Name=tag:Name,Values=Daily Deen Web Server" "Name=instance-state-name,Values=running" \
            --query "Reservations[0].Instances[0].PublicDnsName" \
            --output text)

          echo "Server DNS: $DNS"
          echo "server_dns=$DNS" >> $GITHUB_OUTPUT

      - name: 📝 Create Ansible inventory
        run: |
          cat > inventory.ini <<EOF
          [webserver]
          ${{ steps.get-dns.outputs.server_dns }} ansible_user=ec2-user ansible_ssh_private_key_file=~/.ssh/daily-deen-key
          EOF
          cat inventory.ini

      - name: 🚀 Run Ansible Playbook
        run: |
          ansible-playbook -i inventory.ini playbook.yml

      - name: 🎉 Deployment Complete!
        run: |
          IP=$(aws ec2 describe-instances \
            --filters "Name=tag:Name,Values=Daily Deen Web Server" "Name=instance-state-name,Values=running" \
            --query "Reservations[0].Instances[0].PublicIpAddress" \
            --output text)

          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "✅ Deployment successful!"
          echo "🌐 Your website is live at:"
          echo "   http://$IP"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
